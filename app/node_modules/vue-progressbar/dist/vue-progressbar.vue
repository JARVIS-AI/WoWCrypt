<template>
    <div :show="show" :init="init" :options="options" :reference="reference" :class="classStyle" :style="style"></div>
</template>
<script>
const gradients = require('./assets/gradient-classes')

const inBrowser = typeof window !== 'undefined'
export default {
  name: 'VueProgress',
  serverCacheKey: (props) => 'Progress-'+props.reference,
  props: ['reference', 'options', 'init', 'show'],
  data () {
    return {
      gradient: "",
      currentProgression: -1,
      previousPercentage: -1
    }
  },
  created () {
    if (this.init === true) {
      this.$pb.create(this.reference, this.options)
    }
  },
  computed: {
    style() {
      if (this.previousPercentage !== this.bar.percent)
      this.previousPercentage = this.bar.percent
      let options
      !this.bar.temp.use ? options = this.bar.options : options = this.bar.temp
      if (this.bar.quicklyHid) {
        this.bar.quicklyHid = this.bar.quickHide = false
      }
      let position = options.location
      let trailAsNumber = parseFloat(options.trail.replace('/(px)/'))
      let style = {
        'opacity': options.show ? 1 : 0
      }
      let comparison = this.currentProgression;
      if (options.rGradient && this.bar.currentProgression > comparison) {
        this.currentProgression = this.bar.currentProgression
        this.gradient = gradients.classes[Math.floor(Math.random() * (gradients.classes.length - 5)) + 5]
      }
      if (options.canSuccess && !options.rGradient) {
        style['background-color'] = options.color
      } else if (!options.canSuccess){
        style['background-color'] = options.failedColor + '!important'
      }
      if (position == 'top' || position == 'bottom') {
        position == 'top' ? style.top = '0px' : style.bottom = '0px'
        !this.bar.quickHide && !this.bar.hidden ? style.height = options.thickness : style.height = '0px'
        if (trailAsNumber >= 0) {
          if (options.inverse) {
            this.classStyle = "__cov-progress right "
            options.rGradient ? this.classStyle += this.gradient : null
            style.margin = "0 " + (this.bar.percent) + "vw 0 " + -1*this.bar.percent + "vw"
            !this.bar.hidden && this.bar.percent === 0 ? style.right = (-1*trailAsNumber) + 'px' : style.right = '0px'
          } else {
            this.classStyle = "__cov-progress left "
            options.rGradient ? this.classStyle += this.gradient : null
            style.margin = "0 " + (-1*this.bar.percent) + "vw 0 " + this.bar.percent + "vw"
            !this.bar.hidden && this.bar.percent === 0 ? style.left = (-1*trailAsNumber) + 'px' : style.left = '0px'
          }
          if (this.bar.hidden) {
            style.width = '0px'
            style.height = '0px'
            this.previousPercentage = -1
          } else if (!this.bar.quickHide) {
            style.width = trailAsNumber + 'px'
          } else {
            style.width = '0px'
            style.height = '0px'
          }
          !this.bar.quickHide ? style.transition = "left " + options.transition.time + ", right " + options.transition.time + ", margin " + options.transition.time + ", width 1ms, opacity " + options.transition.opacity : style.transition = "height 1ms, margin 1ms, width 1ms, left 1ms, right 1ms, opacity 1ms"
        } else {
          if (options.inverse) {
            this.classStyle = "__cov-progress right "
            options.rGradient ? this.classStyle += this.gradient : null
            style.right = '0px'
          } else {
            this.classStyle = "__cov-progress left "
            options.rGradient ? this.classStyle += this.gradient : null
            style.left = '0px'
          }
          !this.bar.quickHide ? style.transition = "width " + options.transition.time + ", opacity " + options.transition.opacity : style.transition = "width 1ms, opacity 1ms"
          !this.bar.quickHide ? style.width = this.bar.percent + '%' : style.width = '0%'
        }
      } else if (position == 'left' || position == 'right') {
        position == 'left' ? style.left = '0px' : style.right = '0px'
        !this.bar.quickHide && !this.bar.hidden ? style.width = options.thickness : style.width = "0px"
        if (trailAsNumber >= 0) {
          if (options.inverse) {
            this.classStyle = "__cov-progress top "
            options.rGradient ? this.classStyle += "side " + this.gradient : null
            style.margin = this.bar.percent + "vh 0 " + (-1*this.bar.percent) + "vh 0"
            !this.bar.hidden && this.bar.percent === 0 ? style.top = (-1*trailAsNumber) + 'px' : style.top = '0px'
          } else {
            this.classStyle = "__cov-progress bottom "
            options.rGradient ? this.classStyle += "side " + this.gradient : null
            style.margin = (-1*this.bar.percent) + "vh 0 " + this.bar.percent + "vh 0"
            !this.bar.hidden && this.bar.percent === 0 ? style.bottom = (-1*trailAsNumber) + 'px' : style.bottom = '0px'
          }
          if (this.bar.hidden) {
            style.height = '0px'
            style.width = '0px'
            this.previousPercentage = -1
          } else if (!this.bar.quickHide) {
            style.height = trailAsNumber + 'px'
          } else {
            style.height = '0px'
            style.width = '0px'
          }
          !this.bar.quickHide ? style.transition = "margin " + options.transition.time + ", height 1ms, top " + options.transition.time + ", bottom " + options.transition.time + ", opacity " + options.transition.opacity : style.transition = "width 1ms, margin 1ms, height 1ms, top 1ms, bottom 1ms, opacity 1ms"
        } else {
          if (!options.inverse) {
            this.classStyle = "__cov-progress bottom "
            options.rGradient ? this.classStyle += "side " + this.gradient : null
            style.bottom = '0px'
          } else {
            this.classStyle = "__cov-progress top "
            options.rGradient ? this.classStyle += "side " + this.gradient : null
            style.top = '0px'
          }
          !this.bar.quickHide ? style.transition = "height " + options.transition.time + ", opacity " + options.transition.opacity : style.transition = "height 1ms, opacity 1ms"
          !this.bar.quickHide ? style.height = this.bar.percent + '%' : style.height = '0%'
        }
      }
      this.bar.quickHide ? this.bar.quicklyHid = true : null
      return style
    },
    bar() {
      if (inBrowser) {
        return this.$pb.get(this.reference).data
      } else {
        return {
          init: true,
          initiated: false,
          percent: 0,
          hidden: true,
          currentProgression: 0,
          quickHide: false,
          quicklyHid: false,
          temp: {
            rGradient: true,
            use: false,
            autoRevert: true,
            canSuccess: true,
            color: 'rgb(19, 91, 55)',
            debug: false,
            failedColor: 'red',
            inverse: false,
            location: 'top',
            show: false,
            thickness: '2px',
            trail: '-1px',
            transition: {
              time: '0.2s',
              opacity: '0.6s'
            }
          },
          options: {
            rGradient: false,
            autoRevert: true,
            canSuccess: true,
            color: 'rgb(19, 91, 55)',
            debug: false,
            failedColor: 'red',
            inverse: false,
            location: 'top',
            show: false,
            thickness: '2px',
            trail: '-1px',
            transition: {
              time: '0.2s',
              opacity: '0.6s'
            }
          }
        }
      }
    }
  }
}
</script>
<style src="./assets/stylelist.css">
</style>
